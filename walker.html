<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Walker Bots Demo</title>
</head>
<body>
<select id="botname">
    <option value="0">Rand Bot</option>
    <option value="1">SA Bot</option>
    <option value="2">Cell Bot</option>
</select>
<input id="run" type="button" value="Run">
<input id="stop" type="button" value="Stop">
<br>
<div style="border: solid;width:500px;height:500px">
<canvas id="room" width="500" height="500">
</canvas>
</div>
<span id="coverage"></span>
<script type="application/javascript">
    /**
     * @constructor
     */
    function Env(angle, x, y, context) {
        this.angle = angle;
        this.x = x;
        this.y = y;
        this.speed = 1;
        this.context = context;
    }
    Env.prototype.rotate = function(angle) {
        this.angle = this.angle + angle;
    };
    Env.prototype.move = function () {
        return this.update(0.1);
    };
    Env.prototype.update = function (delta) {
        var dx = this.speed * Math.cos(this.angle);
        var dy = this.speed * Math.sin(this.angle);
        var nx = this.x + dx * delta;
        var ny = this.y + dy * delta;
        if (nx >=0 && ny >=0 && nx <= 1 && ny <= 1) {
            var ctx = this.context;
            ctx.beginPath();
            ctx.lineWidth = 5;
            ctx.moveTo(this.x * 500, this.y * 500);
            ctx.lineTo(nx * 500, ny * 500);
            ctx.stroke();
            this.x = nx;
            this.y = ny;
            return true;
        } else {
            return false;
        }
    };

    /**
     * @constructor
     */
    function RandBot(env) {
        this.env = env;
    }
    RandBot.prototype.update = function() {
        var b = this.env.move();
        if (!b) {
            this.env.rotate(Math.PI + (Math.PI/4 * (2*Math.random() - 1)));
        }
    };
    /**
     * @constructor
     */
    function SABot() {

    }
    SABot.prototype.update = function() {

    };
    /**
     * @constructor
     */
    function CellBot() {

    }
    CellBot.prototype.update = function() {

    };

    var bots = [
        function(env) { return new RandBot(env) },
        function(env) { return new SABot(env) },
        function(env) { return new CellBot(env) }
    ];
    var runButton = document.getElementById('run');
    runButton.addEventListener('click', function() {
        var select = document.getElementById('botname');
        var botId = parseInt(select.options[select.selectedIndex].value);
        var canvas = document.getElementById('room');
        var ctx = canvas.getContext("2d");
        var env = new Env(Math.random() * Math.PI, Math.random(), Math.random(), ctx);
        var bot = bots[botId](env);
        var update = function() {
            bot.update();
            window.requestAnimationFrame(update);
        };
        update();
        var cvg = document.getElementById('coverage');
        var stats = function() {
            var id = ctx.getImageData(0, 0, 100, 100);
            var white = 0;
            var black = 0;
            for (var i = 0; i < id.data.length; i+=4) {
                if (id.data[i + 3] == 0) {
                    black++;
                } else {
                    white++;
                }
            }
            cvg.innerText = 'Coverage : ' + 100 * white / (black + white);
            window.requestAnimationFrame(stats);
        };
        stats();
    }, false);
</script>
</body>

</html>
